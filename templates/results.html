<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - {{ scan.domain }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .scrollable-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .badge-status {
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">BBH Automation</a>
            <a href="/" class="btn btn-outline-light btn-sm">Back to Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Results for {{ scan.domain }}</h2>
            <span
                class="badge {% if scan.status == 'Completed' %}bg-success{% elif scan.status == 'Running' %}bg-primary{% else %}bg-danger{% endif %} badge-status">
                {{ scan.status }}
            </span>
        </div>

        <!-- Summary Stats -->
        <div class="row">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title">Subdomains</h6>
                        <p class="display-6 text-primary">{{ stats.subdomains_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title">Live Hosts</h6>
                        <p class="display-6 text-success">{{ stats.live_hosts_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title">Open Ports</h6>
                        <p class="display-6 text-danger">{{ stats.open_ports_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title">URLs</h6>
                        <p class="display-6 text-info">{{ stats.urls_count }}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h6 class="card-title">JS Files</h6>
                        <p class="display-6 text-warning">{{ stats.js_files_count }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Lists -->
        <div class="row">
            <!-- Subdomains List -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">Subdomains (first 100)</div>
                    <div class="card-body scrollable-list">
                        <ul class="list-group list-group-flush">
                            {% for sub in subdomains %}
                            <li class="list-group-item">{{ sub.subdomain }}</li>
                            {% else %}
                            <li class="list-group-item text-muted">No subdomains found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Live Hosts List with Checkboxes -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-success text-white">Live Hosts (first 100)</div>
                    <div class="card-body scrollable-list">
                        <ul class="list-group list-group-flush">
                            {% for host in live_hosts %}
                            <li class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input host-checkbox" type="checkbox" value="{{ host.url }}"
                                        id="host-{{ loop.index }}">
                                    <label class="form-check-label" for="host-{{ loop.index }}" style="width: 100%;">
                                        <a href="{{ host.url }}" target="_blank">{{ host.url }}</a>
                                        {% if host.status_code %}
                                        <span class="badge bg-secondary">{{ host.status_code }}</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </li>
                            {% else %}
                            <li class="list-group-item text-muted">No live hosts found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Open Ports List -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-danger text-white">Open Ports (first 100)</div>
                    <div class="card-body scrollable-list">
                        <ul class="list-group list-group-flush">
                            {% for port in open_ports %}
                            <li class="list-group-item">
                                <strong>{{ port.host }}</strong>:<span class="badge bg-danger">{{ port.port }}</span>
                            </li>
                            {% else %}
                            <li class="list-group-item text-muted">No open ports found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <!-- URLs List -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-info text-white">URLs (first 100)</div>
                    <div class="card-body scrollable-list">
                        <ul class="list-group list-group-flush">
                            {% for url_item in urls %}
                            <li class="list-group-item text-truncate" title="{{ url_item.url }}">
                                <a href="{{ url_item.url }}" target="_blank">{{ url_item.url }}</a>
                            </li>
                            {% else %}
                            <li class="list-group-item text-muted">No URLs found.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- On-Demand Scanning Section -->
        {% if live_hosts %}
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <strong>üîß On-Demand Scanning</strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-3">Select hosts from the list above and run additional scans:</p>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary" onclick="runSelectedScan('gau')">
                                üì° Run GAU on Selected Hosts
                            </button>
                            <button class="btn btn-danger" onclick="runSelectedScan('nuclei')">
                                üêõ Run Nuclei on Selected Hosts
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="selectAllHosts()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="deselectAllHosts()">Deselect All</button>
                        </div>
                        <div id="scan-status" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Scan Information -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">Scan Information</div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <th>Scan ID:</th>
                                <td>{{ scan.id }}</td>
                            </tr>
                            <tr>
                                <th>Domain:</th>
                                <td>{{ scan.domain }}</td>
                            </tr>
                            <tr>
                                <th>Scan Type:</th>
                                <td>{{ 'Standard' if scan.scan_type == 'standard' else scan.scan_type.title() }}</td>
                            </tr>
                            <tr>
                                <th>Started:</th>
                                <td>{{ scan.start_time }}</td>
                            </tr>
                            <tr>
                                <th>Completed:</th>
                                <td>{{ scan.end_time or 'In Progress' }}</td>
                            </tr>
                            {% if scan.tools %}
                            <tr>
                                <th>Tools:</th>
                                <td>{{ scan.tools|join(', ') }}</td>
                            </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function selectAllHosts() {
            document.querySelectorAll('.host-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllHosts() {
            document.querySelectorAll('.host-checkbox').forEach(cb => cb.checked = false);
        }

        function runSelectedScan(tool) {
            const selectedHosts = Array.from(document.querySelectorAll('.host-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedHosts.length === 0) {
                alert('Please select at least one host');
                return;
            }

            const statusDiv = document.getElementById('scan-status');
            statusDiv.innerHTML = `<div class="alert alert-info">Running ${tool.toUpperCase()} on ${selectedHosts.length} host(s)... This may take a while.</div>`;

            fetch(`/api/scan/{{ scan.id }}/run-tool`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tool: tool,
                    hosts: selectedHosts
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
                });
        }
    </script>
</body>

</html>