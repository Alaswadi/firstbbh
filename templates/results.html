<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Results - {{ scan.domain }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .scrollable-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .badge-status {
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">BBH Automation</a>
            <a href="/" class="btn btn-outline-light btn-sm">Back to Dashboard</a>
        </div>
    </nav>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Results for {{ scan.domain }}</h2>
            <div class="form-check">
                <input class="form-check-input host-checkbox" type="checkbox" value="{{ host.url }}"
                    id="host-{{ loop.index }}">
                <label class="form-check-label" for="host-{{ loop.index }}" style="width: 100%;">
                    <a href="{{ host.url }}" target="_blank">{{ host.url }}</a>
                    {% if host.status_code %}
                    <span class="badge bg-secondary">{{ host.status_code }}</span>
                    {% endif %}
                </label>
            </div>
            <div class="card-header bg-warning text-dark">
                <strong>üîß On-Demand Scanning</strong>
            </div>
            <div class="card-body">
                <p class="mb-3">Select hosts from the list above and run additional scans:</p>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-primary" onclick="runSelectedScan('gau')">
                        üì° Run GAU on Selected Hosts
                    </button>
                    <button class="btn btn-danger" onclick="runSelectedScan('nuclei')">
                        üêõ Run Nuclei on Selected Hosts
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="selectAllHosts()">Select All</button>
                    <button class="btn btn-secondary btn-sm" onclick="deselectAllHosts()">Deselect All</button>
                </div>
                <div id="scan-status" class="mt-3"></div>
            </div>
        </div>
    </div>
    </div>
    {% endif %}

    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Scan Information</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th>Scan ID:</th>
                            <td>{{ scan.id }}</td>
                        </tr>
                        <tr>
                            <th>Domain:</th>
                            <td>{{ scan.domain }}</td>
                        </tr>
                        <tr>
                            <th>Scan Type:</th>
                            <td>{{ 'Standard' if scan.scan_type == 'standard' else scan.scan_type.title() }}</td>
                        </tr>
                        <tr>
                            <th>Started:</th>
                            <td>{{ scan.start_time }}</td>
                        </tr>
                        <tr>
                            <th>Completed:</th>
                            <td>{{ scan.end_time or 'In Progress' }}</td>
                        </tr>
                        {% if scan.tools %}
                        <tr>
                            <th>Tools:</th>
                            <td>{{ scan.tools|join(', ') }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script>
        function selectAllHosts() {
            document.querySelectorAll('.host-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllHosts() {
            document.querySelectorAll('.host-checkbox').forEach(cb => cb.checked = false);
        }

        function runSelectedScan(tool) {
            const selectedHosts = Array.from(document.querySelectorAll('.host-checkbox:checked'))
                .map(cb => cb.value);

            if (selectedHosts.length === 0) {
                alert('Please select at least one host');
                return;
            }

            const statusDiv = document.getElementById('scan-status');
            statusDiv.innerHTML = `<div class="alert alert-info">Running ${tool.toUpperCase()} on ${selectedHosts.length} host(s)... This may take a while.</div>`;

            fetch(`/api/scan/{{ scan.id }}/run-tool`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    tool: tool,
                    hosts: selectedHosts
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        statusDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `<div class="alert alert-danger">Error: ${error}</div>`;
                });
        }
    </script>
</body>

</html>